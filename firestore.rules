
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users can manage their own profile
    match /profiles/{userId} {
      allow read, write: if request.auth.uid == userId;

      // Users can manage their own sessions and skills subcollections
      match /{subcollection}/{docId} {
        allow read, write, create, delete: if request.auth.uid == userId;
      }
    }

    // Rules for the 'shares' collection
    match /shares/{shareId} {
      // Allow a user to create a share if they are the student
      allow create: if request.auth.uid == request.resource.data.studentUid;

      // Allow a user to read a share if they are the student OR the guardian
      allow read: if request.auth.uid == resource.data.studentUid || request.auth.token.email == resource.data.guardianEmail;

      // Allow a user to delete a share if they are the student
      allow delete: if request.auth.uid == resource.data.studentUid;
    }
  }
}
